test_that("model d fits are accurate", {
  pred <- gestage_d(birthhc = 30, birthwt = 2800)
  # filter(md, birthhc == 30, birthwt == 2800) %>% pull(fit)
  fit <- round(270.488)
  expect_equal(pred, fit)

  pred <- gestage_d(birthhc = 30, birthwt = 2800, round_pred = FALSE)
  fit <- 270.488
  expect_true(abs(pred - fit) < 0.002)

  pred <- gestage_d(seq(30, 35, by = 0.1), 2800, round_pred = FALSE)
  # fit <- filter(md, birthhc %in% seq(30, 35, by = 0.1), birthwt == 2800) %>%
  #   pull(fit)
  fit <- c(270.488, 270.62, 270.744, 270.862, 270.971, 271.074, 271.169,
    271.258, 271.342, 271.422, 271.499, 271.575, 271.65, 271.728,
    271.808, 271.892, 271.981, 272.075, 272.175, 272.281, 272.393,
    272.512, 272.636, 272.797, 272.963, 273.133, 273.306, 273.482,
    273.661, 273.842, 274.023, 274.206, 274.389, 274.572, 274.755,
    274.937, 275.12, 275.301, 275.482, 275.661, 275.84, 276.017,
    276.192, 276.365, 276.537, 276.705, 276.87, 277.033, 277.159,
    277.25, 277.336)
  expect_true(sd(pred - fit) < 0.08)

  bwt <- seq(3005, 3500, by = 5)
  pred <- gestage_d(30, bwt, round_pred = FALSE)
  # fit <- filter(md, birthhc == 30, birthwt %in% bwt) %>% pull(fit)
  fit <- c(272.175, 272.21, 272.245, 272.279, 272.314, 272.348, 272.382,
    272.415, 272.449, 272.482, 272.515, 272.547, 272.58, 272.612,
    272.643, 272.675, 272.706, 272.738, 272.753, 272.767, 272.782,
    272.796, 272.81, 272.823, 272.837, 272.85, 272.863, 272.876,
    272.888, 272.901, 272.913, 272.925, 272.937, 272.948, 272.959,
    272.97, 272.981, 272.992, 273.002, 273.012, 273.022, 273.032,
    273.042, 273.051, 273.06, 273.069, 273.078, 273.086, 273.095,
    273.103, 273.111, 273.119, 273.126, 273.134, 273.141, 273.148,
    273.155, 273.162, 273.168, 273.175, 273.181, 273.187, 273.193,
    273.199, 273.205, 273.21, 273.215, 273.22, 273.226, 273.23, 273.235,
    273.24, 273.244, 273.249, 273.253, 273.257, 273.261, 273.265,
    273.269, 273.272, 273.276, 273.28, 273.283, 273.286, 273.289,
    273.293, 273.296, 273.299, 273.302, 273.304, 273.307, 273.31,
    273.313, 273.315, 273.318, 273.32, 273.323, 273.325, 273.328,
    273.33)
  expect_true(sd(pred - fit) < 0.008)
})

test_that("model d doesn't accept garbage", {
  expect_error(gestage_d(c(31.1, 35.2), 3000:3002),
    regexp = "must be the same")

  expect_error(gestage_d(19, 3000),
    "must be >= 25")

  expect_error(gestage_d(41, 3000),
    "must be <= 40")

  expect_error(gestage_d(35, 500),
    "must be >= 1000")

  expect_error(gestage_d(35, 6000),
    "must be <= 5000")

  expect_message(gestage_d(c(34, 34.234234), 3000),
    "Rounded birthhc to the nearest hundredth")
})
